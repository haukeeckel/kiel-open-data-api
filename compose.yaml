name: kiel-dashboard-api

x-api-env: &api-env
  NODE_ENV: production
  HOST: 0.0.0.0
  PORT: '3000'
  CORS_ORIGIN: http://localhost:3000
  STATS_VALIDATION_CACHE_ENABLED: 'true'
  STATS_VALIDATION_CACHE_TTL_MS: '30000'

x-api-base: &api-base
  build: .
  environment: *api-env
  volumes:
    - duckdb_data:/app/data
    - etl_cache:/app/data/cache
  restart: unless-stopped
  healthcheck:
    test: ['CMD-SHELL', 'curl -f http://127.0.0.1:3000/health || exit 1']
    interval: 15s
    timeout: 5s
    retries: 5
    start_period: 20s

services:
  gateway:
    image: nginx:1.27-alpine
    depends_on:
      - api-blue
      - api-green
    ports:
      - '3000:3000'
    volumes:
      - ./ops/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ops/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./ops/nginx/upstreams:/etc/nginx/upstreams:ro
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'wget -qO- http://127.0.0.1:3000/health >/dev/null 2>&1 || exit 1']
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s

  api-blue:
    <<: *api-base
    environment:
      <<: *api-env
      DUCKDB_PATH: data/kiel-blue.duckdb

  api-green:
    <<: *api-base
    environment:
      <<: *api-env
      DUCKDB_PATH: data/kiel-green.duckdb

  migrate:
    build: .
    environment:
      <<: *api-env
      TARGET_COLOR: green
    volumes:
      - duckdb_data:/app/data
      - etl_cache:/app/data/cache
    command:
      - sh
      - -ec
      - |
        case "$${TARGET_COLOR}" in
          blue|green) export DUCKDB_PATH="data/kiel-$${TARGET_COLOR}.duckdb" ;;
          *) echo "migrate: TARGET_COLOR must be blue or green" >&2; exit 2 ;;
        esac
        node dist/db/cli/migrate.js
    restart: 'no'

  etl:
    build: .
    environment:
      <<: *api-env
      TARGET_COLOR: green
    volumes:
      - duckdb_data:/app/data
      - etl_cache:/app/data/cache
    command:
      - sh
      - -ec
      - |
        case "$${TARGET_COLOR}" in
          blue|green) export DUCKDB_PATH="data/kiel-$${TARGET_COLOR}.duckdb" ;;
          *) echo "etl: TARGET_COLOR must be blue or green" >&2; exit 2 ;;
        esac
        node dist/etl/cli/run.js --all
    restart: 'no'

  backup:
    build: .
    environment:
      <<: *api-env
      DUCKDB_PATH: data/active.duckdb
    volumes:
      - duckdb_data:/app/data
      - duckdb_backups:/backups
    command: ['/app/scripts/ops/backup.sh']
    restart: 'no'

  restore:
    build: .
    environment:
      <<: *api-env
      DUCKDB_PATH: data/active.duckdb
    volumes:
      - duckdb_data:/app/data
      - duckdb_backups:/backups
    command: ['/app/scripts/ops/restore.sh']
    restart: 'no'

volumes:
  duckdb_data:
  etl_cache:
  duckdb_backups:
