name: kiel-dashboard-api

x-app-env: &app-env
  NODE_ENV: production
  HOST: 0.0.0.0
  PORT: '3000'
  CORS_ORIGIN: http://localhost:3000
  DUCKDB_PATH: data/kiel.duckdb
  STATS_VALIDATION_CACHE_ENABLED: 'true'
  STATS_VALIDATION_CACHE_TTL_MS: '30000'

x-app-volumes: &app-volumes
  - duckdb_data:/app/data
  - etl_cache:/app/data/cache

services:
  api:
    build: .
    environment: *app-env
    ports:
      - '3000:3000'
    volumes: *app-volumes
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://127.0.0.1:3000/health || exit 1']
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s

  migrate:
    build: .
    environment: *app-env
    volumes: *app-volumes
    command: ['node', 'dist/db/cli/migrate.js']
    restart: 'no'

  etl:
    build: .
    environment: *app-env
    volumes: *app-volumes
    command: ['node', 'dist/etl/cli/run.js', '--all']
    restart: 'no'

  backup:
    build: .
    environment: *app-env
    volumes:
      - duckdb_data:/app/data
      - duckdb_backups:/backups
    command: ['/app/scripts/ops/backup.sh']
    restart: 'no'

  restore:
    build: .
    environment: *app-env
    volumes:
      - duckdb_data:/app/data
      - duckdb_backups:/backups
    command: ['/app/scripts/ops/restore.sh']
    restart: 'no'

  etl-cron:
    build: .
    profiles: ['cron']
    environment:
      <<: *app-env
      ETL_CRON_INTERVAL_SEC: '86400'
    volumes:
      - duckdb_data:/app/data
      - etl_cache:/app/data/cache
      - duckdb_backups:/backups
    command:
      - 'sh'
      - '-ec'
      - |
        while true; do
          /app/scripts/ops/backup.sh
          node dist/etl/cli/run.js --all || echo "etl-cron: etl failed; retrying next interval"
          sleep "$${ETL_CRON_INTERVAL_SEC:-86400}"
        done
    restart: unless-stopped

volumes:
  duckdb_data:
  etl_cache:
  duckdb_backups:
